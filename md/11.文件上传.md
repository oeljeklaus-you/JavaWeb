# 11.æ–‡ä»¶ä¸Šä¼ 

æ–‡ä»¶ä¸Šä¼ åœ¨Servlet3ä¸­æˆäº†ä¸€é¡¹å†…ç½®çš„ç‰¹æ€§ã€‚

## 11.1 å®¢æˆ·ç«¯ç¼–ç¨‹

```jsp
<%--
  Created by IntelliJ IDEA.
  User: youyujie
  Date: 2018/12/25
  Time: 9:40 AM
  To change this template use File | Settings | File Templates.
--%>
<%@ page contentType="text/html;charset=UTF-8" language="java" %>
<html>
<head>
    <title>æ–‡ä»¶ä¸Šä¼ </title>
</head>
<body>
    <form action="" enctype="multipart/form-data" method="post">
        æ–‡ä»¶ <input type="file" name="fileName"><br>
        <input type="submit" value="æäº¤">
    </form>
</body>
</html>
```

å¤šæ–‡ä»¶ä¸Šä¼ 

```jsp
<%--
  Created by IntelliJ IDEA.
  User: youyujie
  Date: 2018/12/25
  Time: 9:42 AM
  To change this template use File | Settings | File Templates.
--%>
<%@ page contentType="text/html;charset=UTF-8" language="java" %>
<html>
<head>
    <title>å¤šæ–‡ä»¶ä¸Šä¼ </title>
</head>
<body>
<form action="" enctype="multipart/form-data" method="post">
    é€‰æ‹©æ–‡ä»¶:<input type="file" multiple="multiple"><br>
    <input type="submit" value="æäº¤">
</form>
</body>
</html>
```

## 11.2 æœåŠ¡å™¨ç«¯ç¼–ç¨‹

â€‹	Servletçš„æ–‡ä»¶ä¸Šä¼ ç¼–ç¨‹é€šè¿‡ MultipartConfigæ³¨è§£å’Œjavax.servlet.http.Partæ¥å£ã€‚

```java
//
// Source code recreated from a .class file by IntelliJ IDEA
// (powered by Fernflower decompiler)
//

package javax.servlet.annotation;

import java.lang.annotation.ElementType;
import java.lang.annotation.Retention;
import java.lang.annotation.RetentionPolicy;
import java.lang.annotation.Target;

@Target({ElementType.TYPE})
@Retention(RetentionPolicy.RUNTIME)
public @interface MultipartConfig {
    //æ–‡ä»¶çš„ç£ç›˜ä¿å­˜ä½ç½®
    String location() default "";
	//æ–‡ä»¶ä¸Šä¼ çš„æœ€å¤§å®¹é‡é»˜è®¤å€¼è¡¨ç¤ºä¸å—é™åˆ¶
    long maxFileSize() default -1L;
	//å…è®¸å¤šéƒ¨åˆ†HTTPè¯·æ±‚çš„å˜´å•Šå®¹é‡ï¼Œé»˜è®¤å€¼è¡¨ç¤ºä¸å—é™åˆ¶
    long maxRequestSize() default -1L;
	//æº¢å‡ºå°ºå¯¸ï¼Œè¶…è¿‡è¿™ä¸ªå€¼æ–‡ä»¶è¢«å†™å…¥ç£ç›˜
    int fileSizeThreshold() default 0;
}
```

Partæ¥å£

```java
//
// Source code recreated from a .class file by IntelliJ IDEA
// (powered by Fernflower decompiler)
//

package javax.servlet.http;

import java.io.IOException;
import java.io.InputStream;
import java.util.Collection;

public interface Part {
    InputStream getInputStream() throws IOException;
	//å¦‚æœpartæ—¶ä¸€ä¸ªæ–‡ä»¶é‚£ä¹ˆè¿”å›partçš„å†…å®¹éƒ¨åˆ†
    String getContentType();
	//è·å–è¿™éƒ¨åˆ†çš„åç§°
    String getName();

    String getSubmittedFileName();

    long getSize();

    void write(String var1) throws IOException;

    void delete() throws IOException;

    String getHeader(String var1);

    Collection<String> getHeaders(String var1);

    Collection<String> getHeaderNames();
}
```

åœ¨Servletä¸­å¤„ç†ä¸Šä¼ æ–‡ä»¶æ—¶ï¼Œéœ€è¦:

â€‹	1.é€šè¿‡æŸ¥çœ‹æ˜¯å¦å­˜åœ¨content-typeæ ‡å¤´ï¼Œæ£€éªŒä¸€ä¸ªPartæ˜¯æœ¯è¯­æ™®é€šçš„è¡¨å•åŸŸï¼Œè¿˜æ˜¯æ–‡ä»¶ã€‚

â€‹	2.å¦‚æœæœ‰content-typeæ ‡å¤´,é‚£ä¹ˆå°†æŸ¥çœ‹ä¸Šä¼ æ–‡ä»¶åç§°æ˜¯å¦ä¸ºç©ºã€‚æ–‡ä»¶åä¸ºç©ºï¼Œè¡¨ç¤ºæœ‰æ–‡ä»¶ç±»å‹çš„ğŸŸå­˜åœ¨ä½†æ˜¯æ²¡æœ‰é€‰æ‹©è¦ä¸Šä¼ çš„æ–‡ä»¶ã€‚

â€‹	3.å¦‚æœæ–‡ä»¶å­˜åœ¨ï¼Œå°±å¯ä»¥è°ƒç”¨Partä¸­çš„writeæ–¹æ³•æ¥å†™å…¥ç£ç›˜ï¼Œè°ƒç”¨æ—¶åŒæ—¶ä¼ é€’ä¸€ä¸ªç»å¯¹è·¯å¾„ï¼Œæˆ–æ˜¯ç›¸å¯¹MutipartConfigæ³¨è§£çš„locationå±æ€§çš„è·¯å¾„ã€‚

## 11.3 æ–‡ä»¶ä¸Šä¼ æ¡ˆä¾‹

```java
package cn.edu.hust.cn.edu.hust.controller;

import javax.servlet.ServletException;
import javax.servlet.annotation.MultipartConfig;
import javax.servlet.annotation.WebServlet;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.servlet.http.Part;
import java.io.IOException;
import java.nio.file.Files;
import java.nio.file.Path;
import java.nio.file.Paths;
import java.text.SimpleDateFormat;
import java.util.Date;
import java.util.Locale;

@WebServlet(name = "homeServlet",urlPatterns = {"/fileUpServlet","/doFileUpServlet"})
@MultipartConfig
public class HomeServlet extends HttpServlet{
    @Override
    protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        req.getRequestDispatcher("/fileUp.jsp").forward(req,resp);
    }

    @Override
    protected void doPost(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        Part part=req.getPart("fileName");
        String contentType=part.getContentType();
        String sourceFileName=getFileName(part);
        //åˆ¤æ–­æ˜¯å¦æ˜¯æ–‡ä»¶åŸŸ,ä»¥åŠæ–‡ä»¶æ˜¯å¦æäº¤äº†
        if(contentType!=null&&sourceFileName!=null&&!sourceFileName.isEmpty())
        {
            //è·å–æäº¤çš„åŸºæœ¬è·¯å¾„
            Path basePath=Paths.get(getServletContext().getRealPath("/")+"/"+"uploadFile");
            //åˆ¤æ–­è·¯å¾„æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨å°±åˆ›å»ºç›®å½•
            if(!Files.exists(basePath))
            {
                Files.createDirectory(basePath);
            }
            part.write(basePath.toString()+"/"+sourceFileName+"_"+new SimpleDateFormat("yyyy-MM-dd HH:mm:ss", Locale.CHINA).format(new Date()).toString());
        }
        resp.sendRedirect("/success.jsp");
    }

    private String getFileName(Part part) {
        String contentDispositionHeader=part.getHeader("content-disposition");
        String[] keyValues=contentDispositionHeader.split(";");
        for(String element:keyValues)
        {
            if(element.trim().startsWith("filename"))
                return element.substring(element.indexOf("=")+1).trim().replace("\"","");
        }
        return null;
    }
}
```

## 11.4 å¤šæ–‡ä»¶ä¸Šä¼ 

```java
package cn.edu.hust.cn.edu.hust.controller;

import javax.servlet.ServletException;
import javax.servlet.annotation.MultipartConfig;
import javax.servlet.annotation.WebServlet;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.servlet.http.Part;
import java.io.IOException;
import java.nio.file.Files;
import java.nio.file.Path;
import java.nio.file.Paths;
import java.text.SimpleDateFormat;
import java.util.Collection;
import java.util.Date;
import java.util.Locale;

@WebServlet(name = "multipartFileUploaServlet",urlPatterns = {"/multipartFileUpServlet","/doMultipartFileUpServlet"})
@MultipartConfig
public class MultipartFileUploaServlet extends HttpServlet {
    @Override
    protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        req.getRequestDispatcher("/multipleFileUp.jsp").forward(req,resp);
    }

    @Override
    protected void doPost(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        Collection<Part> parts=req.getParts();
        for(Part part:parts)
        {
            String contentType=part.getContentType();
            String sourceFileName=getFileName(part);
            //åˆ¤æ–­æ˜¯å¦æ˜¯æ–‡ä»¶åŸŸ,ä»¥åŠæ–‡ä»¶æ˜¯å¦æäº¤äº†
            if(contentType!=null&&sourceFileName!=null&&!sourceFileName.isEmpty())
            {
                //è·å–æäº¤çš„åŸºæœ¬è·¯å¾„
                Path basePath= Paths.get(getServletContext().getRealPath("/")+"/"+"uploadFile");
                //åˆ¤æ–­è·¯å¾„æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨å°±åˆ›å»ºç›®å½•
                if(!Files.exists(basePath))
                {
                    Files.createDirectory(basePath);
                }
                part.write(basePath.toString()+"/"+sourceFileName+"_"+new SimpleDateFormat("yyyy-MM-dd HH:mm:ss", Locale.CHINA).format(new Date()).toString());
            }
        }
        resp.sendRedirect("/success.jsp");
    }

    private String getFileName(Part part) {
        String contentDispositionHeader=part.getHeader("content-disposition");
        String[] keyValues=contentDispositionHeader.split(";");
        for(String element:keyValues)
        {
            if(element.trim().startsWith("filename"))
                return element.substring(element.indexOf("=")+1).trim().replace("\"","");
        }
        return null;
    }
}
```

